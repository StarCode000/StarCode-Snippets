# StarCode Snippets - 从 S3 迁移到 Git 同步功能实施计划

## 目标

将 StarCode Snippets 插件的云同步功能从基于 AWS S3 的实现迁移到基于 Git 的实现，支持 GitHub、GitLab 和 Gitee。

## 实施阶段与任务

### 阶段零：准备工作

*   [x] 制定详细的实施计划并创建此追踪文件。
*   [x] **开发者**: 备份当前完整的项目代码。

---

### 阶段一：移除现有 S3 同步逻辑

*   **任务 1.1: 移除 S3 NPM 依赖**
    *   [x] 从 `package.json` 的 `dependencies` 中删除 `@aws-sdk/client-s3`。
    *   [x] 运行 `npm uninstall @aws-sdk/client-s3` (或 `yarn remove`)。
*   **任务 1.2: 清理 `CloudSyncManager.ts` 中的 S3 逻辑**
    *   [x] 删除所有 `S3Client` 相关的导入和核心S3操作方法 (`downloadFile`, `uploadFile`, `deleteFile`, `fileExists`, `initializeS3Client` 等)。
    *   [x] 删除 `HISTORY_FILE_KEY`, `METADATA_FILE_KEY`, `SNIPPETS_PREFIX` 常量。
    *   [x] 移除与 `history.txt` 和 `metadata.json` 生成/解析相关的逻辑。
    *   [x] **注意**: 高层同步流程方法 (`performSync`, `pushLocalChanges`, `pullRemoteChanges`, `handleConflicts`) 的外壳暂时保留，内部实现后续替换为Git逻辑。
*   **任务 1.3: 更新 `SettingsWebviewProvider.ts` (UI 和逻辑)**
    *   [x] 从 `_getHtmlForWebview` 方法返回的HTML中移除所有S3相关的表单字段和描述文本。
    *   [x] 移除处理S3配置保存、测试连接 (`_testConnection`)、S3配置重置的JavaScript和后端消息处理逻辑。
    *   [x] 移除 "强制重置云端同步" (`_forceResetCloudSync`) 和 "放弃本地，从云端导入" (`_abandonLocalAndImport`) 按钮及其后端逻辑。
*   **任务 1.4: 更新 `SettingsManager.ts`**
    *   [x] 从 `CloudSyncConfig` 类型定义中移除S3相关字段。
    *   [x] 修改 `getDefaultConfig()` 以返回一个空的或最小化的配置结构 (后续会被Git配置替换)。
    *   [x] 移除 `validateConfig` 中对S3字段的校验。
*   **任务 1.5: 评估并修改 `HistoryManager.ts`**
    *   [x] 分析 `HistoryManager.ts`。由于Git接管版本历史，此类大部分功能将废弃。
    *   [x] 决定是大幅简化还是准备完全移除该文件。
*   **任务 1.6: 清理 `package.json` 中的相关命令和配置**
    *   [x] 检查 `contributes.commands`，移除或注释掉不再适用的S3同步命令。
    *   [x] 检查 `contributes.configuration`，移除或注释掉与S3相关的配置项。

---

## ✅ 阶段一完成总结

**已完成的工作：**
*   ✅ 移除了 `@aws-sdk/client-s3` NPM 依赖
*   ✅ 删除了 `HistoryManager.ts` 文件（S3特定的历史管理）
*   ✅ 清理了 `CloudSyncManager.ts` 中的所有S3逻辑，保留同步流程骨架
*   ✅ 完全重构了 `SettingsWebviewProvider.ts` UI，移除S3表单和危险操作
*   ✅ 更新了 `CloudSyncConfig` 类型定义为Git配置
*   ✅ 更新了 `SettingsManager.ts` 的默认配置和验证逻辑
*   ✅ 更新了 `package.json` 中的配置定义

**当前状态：**
*   所有S3相关逻辑已移除
*   UI已更新为Git同步的占位符界面
*   配置结构已准备好支持GitHub、GitLab、Gitee
*   同步逻辑框架已保留，等待Git实现

---

### 阶段二：引入 Git 基础功能

*   **任务 2.1: 选择并安装 Git 库**
    *   [x] 决定使用 `simple-git` 或 `isomorphic-git`。 (初步倾向 `simple-git`)
    *   [x] 运行 `npm install <git-library>` (或 `yarn add`)。
*   **任务 2.2: 定义新的 Git 配置结构**
    *   [x] 在 `SettingsManager.ts` 中定义新的 `GitSyncConfig` 类型 (包括 `provider`, `repositoryUrl`, `authenticationMethod`, `token`, `sshKeyPath`, `localPath`, `defaultBranch`, `commitMessageTemplate` 等字段)。
    *   [x] 更新 `getDefaultConfig()` 以返回默认的 `GitSyncConfig`。
    *   [x] 更新 `validateConfig` 以校验新的Git配置字段。
    *   [x] 在 `package.json` 的 `contributes.configuration` 部分添加新的Git配置项。
*   **任务 2.3: 重建 `SettingsWebviewProvider.ts` 的 UI 和逻辑**
    *   [x] 设计并实现新的HTML表单 (`_getHtmlForWebview`) 以支持Git平台选择、仓库URL、认证方式、Token/SSH配置等。
    *   [x] 实现新的JavaScript逻辑以处理Git配置的加载、保存和基本校验。
    *   [x] 实现新的后端消息处理逻辑 (`onDidReceiveMessage`) 对应新的UI操作。
*   **任务 2.4: 创建/重构 `GitSyncManager.ts` (或原 `CloudSyncManager.ts`)**
    *   [x] 导入选定的Git库。
    *   [x] 实现本地仓库管理：
        *   [x] `initOrOpenLocalRepo()`: 初始化 (git init) 或打开本地仓库。
        *   [x] `configureRemote()`: 添加或更新远程仓库 (git remote add/set-url)。
    *   [x] 实现核心Git操作的封装函数：
        *   [x] `gitPull(branch)`
        *   [x] `gitAddAll()`
        *   [x] `gitCommit(message)`
        *   [x] `gitPush(branch)`
        *   [x] `gitStatus()`
        *   [x] `gitFetch()`
        *   [x] `generateCommitMessage()` (生成提交信息)
    *   [x] 更新 `testConnection()` 方法以测试Git连接。
    *   [x] 更新 `isConfigured()` 方法以检查Git配置完整性。
    *   [x] **注意**: 初步实现时，认证细节已实现Token认证，SSH认证待完善。

---

## ✅ 阶段二完成总结

**已完成的工作：**
*   ✅ 安装了 `simple-git` 依赖库
*   ✅ 完全更新了Git配置结构，包括类型定义和验证逻辑
*   ✅ 重建了 `SettingsWebviewProvider.ts` 的用户界面，支持完整的Git配置
*   ✅ 实现了 `CloudSyncManager.ts` 中的核心Git操作：
    *   ✅ 本地仓库初始化和管理
    *   ✅ 远程仓库配置和令牌认证
    *   ✅ Git基础操作（pull, push, add, commit, status, fetch）
    *   ✅ Git连接测试功能
*   ✅ 更新了配置导入/导出功能以支持Git配置格式
*   ✅ 实现了旧S3配置到新Git配置的迁移检测

**当前功能状态：**
*   ✅ **配置管理**：用户可以完整配置GitHub、GitLab、Gitee同步
*   ✅ **连接测试**：可以测试Git仓库连接和令牌有效性
*   ✅ **认证支持**：支持Token认证（SSH认证框架已准备，待完善）
*   ✅ **用户界面**：完整的Git配置界面，支持所有配置项
*   🟡 **同步功能**：基础Git操作已实现，完整同步逻辑待实现

**下一步准备：**
现在可以进入**阶段三：实现核心 Git 同步流程**，包括：
- 重写 `performSync` 方法的Git版本
- 实现Git冲突检测和处理
- 调整 `StorageManager` 以在Git仓库中存储代码片段

**⚠️ 重要修复：**
- ✅ 修复了 `historyWebviewProvider.ts` 中对已删除 `historyManager` 的引用
- ✅ 将历史记录功能更新为Git兼容的界面，指导用户使用VS Code内置Git功能
- ✅ 解决了所有构建错误，现在项目应该可以正常编译

---

### 阶段三：实现核心 Git 同步流程

*   **任务 3.1: 重写 `performSync` 逻辑 (在 `GitSyncManager.ts`)**
    *   [ ] 获取Git配置。
    *   [ ] 确保本地仓库初始化并配置了远程。
    *   [ ] **拉取远程变更**: 执行 `gitPull()`。
    *   [ ] **处理合并冲突**:
        *   检测 `gitPull()` 是否导致冲突。
        *   如果冲突，通知用户，并提供引导（例如，使用VS Code内置工具解决）。
        *   提供机制让用户在解决冲突后继续同步。
    *   [ ] **检测本地变更**:
        *   将当前工作区的代码片段/目录状态与本地Git仓库的 `HEAD` 进行比较 (或者直接使用 `gitStatus()` 判断是否有未提交更改)。
        *   *这一步需要明确如何将项目中的片段数据序列化到文件系统中，以便Git追踪。*
    *   [ ] **提交本地变更**: 如果有本地更改，执行 `gitAddAll()` 和 `gitCommit()` (使用配置的提交信息模板)。
    *   [ ] **推送本地变更**: 执行 `gitPush()`。
    *   [ ] 更新同步状态 (成功时间，错误信息等) 到 `SettingsManager`。
*   **任务 3.2: 调整 `StorageManager.ts`**
    *   [ ] 修改 `StorageManager.ts`，使其直接在用户配置的本地Git仓库路径 (`GitSyncConfig.localPath`) 下读写代码片段文件和目录。
    *   [ ] 确定代码片段的存储格式 (例如，每个片段一个JSON文件，或Markdown文件)。
    *   [ ] 目录结构直接对应文件系统中的目录。
*   **任务 3.3: 实现认证策略**
    *   [ ] **Token认证**:
        *   安全存储和读取用户提供的Token。
        *   配置 `simple-git` 以使用Token (例如，通过环境变量或修改远程URL `