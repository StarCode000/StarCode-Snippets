<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StarCode Snippets åŒæ­¥å†å²è®°å½•æ¨¡æ‹Ÿå™¨</title>
  <style>
    :root {
      --primary-color: #007acc;
      --secondary-color: #2c2c32;
      --background-color: #1e1e1e;
      --panel-bg: #252526;
      --border-color: #444;
      --text-color: #e0e0e0;
      --hover-color: #2a2d2e;
      --selected-color: #37373d;
      --danger-color: #e05252;
      --success-color: #6a9955;
      --dir-color: #dcdcaa;
      --snippet-color: #4fc1ff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      padding: 20px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 20px;
    }

    h1 {
      font-size: 1.8rem;
      color: var(--primary-color);
    }

    h2 {
      font-size: 1.2rem;
      margin-bottom: 10px;
    }

    .controls {
      height: 48px;
      display: flex;
      gap: 10px;
    }

    button {
      background-color: var(--secondary-color);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
      white-space: nowrap;
    }

    .controls > button {
      width: 150px;
    }

    button:hover {
      background-color: var(--hover-color);
    }

    button.primary {
      background-color: var(--primary-color);
      color: white;
    }

    button.danger {
      background-color: var(--danger-color);
      color: white;
    }

    select,
    input,
    textarea {
      background-color: var(--secondary-color);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      padding: 8px 12px;
      border-radius: 4px;
      width: 100%;
    }

    .content {
      display: grid;
      grid-template-columns: 1fr 1fr 2fr;
      gap: 20px;
      height: calc(100vh - 100px);
      overflow: hidden;
    }

    .tree-panel,
    .action-panel,
    .history-panel {
      background-color: var(--panel-bg);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 15px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    .directory-tree {
      overflow-y: auto;
      flex-grow: 1;
    }

    .tree-node {
      display: flex;
      flex-direction: column;
      margin: 2px 0;
    }

    .tree-node-header {
      display: flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }

    .tree-node-header:hover {
      background-color: var(--hover-color);
    }

    .tree-node-header.selected {
      background-color: var(--selected-color);
    }

    .tree-node-content {
      flex: 1;
      display: flex;
      align-items: center;
    }

    .tree-node-icon {
      margin-right: 6px;
      font-size: 1.1em;
    }

    .tree-node-actions {
      display: flex;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .tree-node-header:hover .tree-node-actions {
      opacity: 1;
    }

    .tree-node-actions button {
      padding: 2px 6px;
      margin-left: 4px;
      font-size: 0.8rem;
      background-color: var(--secondary-color);
    }

    .action-delete {
      background-color: var(--danger-color) !important;
      color: white;
    }

    .directory .tree-node-content {
      color: var(--dir-color);
      font-weight: bold;
    }

    .file .tree-node-content {
      color: var(--snippet-color);
    }

    .tree-node-children {
      margin-left: 24px;
      border-left: 1px dashed var(--border-color);
      padding-left: 8px;
    }

    .root-node {
      margin-bottom: 10px;
    }

    .root-node > .tree-node-header {
      font-weight: bold;
    }

    .root-node > .tree-node-children {
      margin-left: 12px;
    }

    .selected {
      background-color: var(--selected-color);
      border-radius: 4px;
    }

    .action-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .history-records {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .history-header {
      display: grid;
      grid-template-columns: 60px 1fr 1fr 1fr 100px;
      gap: 10px;
      padding: 10px 5px;
      background-color: var(--secondary-color);
      font-weight: bold;
      border-bottom: 1px solid var(--border-color);
    }

    .history-content {
      overflow-y: auto;
      flex-grow: 1;
    }

    .history-item {
      display: grid;
      grid-template-columns: 60px 1fr 1fr 1fr 100px;
      gap: 10px;
      padding: 10px 5px;
      border-bottom: 1px solid var(--border-color);
    }

    .history-item:hover {
      background-color: var(--hover-color);
    }

    .op-type {
      font-weight: bold;
    }

    .op-type.add {
      color: var(--success-color);
    }

    .op-type.modify {
      color: var(--primary-color);
    }

    .op-type.delete {
      color: var(--danger-color);
    }

    .op-type.reset {
      color: #ff8c00;
    }

    .path {
      word-break: break-all;
    }

    .hash {
      font-family: monospace;
      word-break: break-all;
    }

    .timestamp,
    .device {
      white-space: nowrap;
    }
    
    /* é€šçŸ¥æç¤ºæ ·å¼ */
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      background-color: var(--panel-bg);
      color: var(--text-color);
      border-left: 4px solid var(--primary-color);
      border-radius: 4px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s, transform 0.3s;
      max-width: 350px;
    }
    
    .notification.success {
      border-left-color: var(--success-color);
    }
    
    .notification.error {
      border-left-color: var(--danger-color);
    }
    
    .notification.warning {
      border-left-color: #ff8c00;
    }
    
    .notification.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>StarCode Snippets åŒæ­¥å†å²è®°å½•æ¨¡æ‹Ÿå™¨</h1>
      <div class="controls">
        <button id="resetBtn" class="danger">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
        <button id="generateRandomBtn">éšæœºç”Ÿæˆå†å²è®°å½•</button>
        <button id="exportBtn">å¯¼å‡ºå†å²è®°å½•</button>
        <button id="importBtn">å¯¼å…¥å†å²è®°å½•</button>
        <input type="file" id="importFile" accept=".txt" style="display: none;">
        <select id="deviceSelector">
          <option value="device1">è®¾å¤‡1</option>
          <option value="device2">è®¾å¤‡2</option>
          <option value="device3">è®¾å¤‡3</option>
        </select>
      </div>
    </header>

    <div class="content">
      <div class="tree-panel">
        <div class="panel-header">
          <h2>ç›®å½•æ ‘</h2>
          <div>
            <button id="copyTreeBtn" title="å¤åˆ¶æ ‘ç»“æ„">å¤åˆ¶æ ‘ç»“æ„</button>
            <button id="addDirBtn">+ æ–°å»ºç›®å½•</button>
          </div>
        </div>
        <div id="directoryTree" class="directory-tree">
          <div class="root-node">
            <div class="tree-node-header ${state.selectedPath === '/' ? 'selected' : ''}" data-path="/">
              <span class="tree-node-icon">ğŸ“</span>
              <span class="tree-node-content">æ ¹ç›®å½•</span>
            </div>
            <div class="tree-node-children" id="root-children"></div>
          </div>
        </div>
      </div>

      <div class="action-panel">
        <div class="panel-header">
          <h2>æ“ä½œé¢æ¿</h2>
        </div>
        <div class="action-form">
          <div class="form-group">
            <label for="actionType">æ“ä½œç±»å‹</label>
            <select id="actionType">
              <option value="addDir">æ–°å¢ç›®å½•</option>
              <option value="addSnippet">æ–°å¢ä»£ç ç‰‡æ®µ</option>
              <option value="modifySnippet">ä¿®æ”¹ä»£ç ç‰‡æ®µ</option>
              <option value="deleteItem">åˆ é™¤é¡¹ç›®</option>
              <option value="forceReset">å¼ºåˆ¶é‡ç½®</option>
            </select>
          </div>

          <div class="form-group" id="pathGroup">
            <label for="path">è·¯å¾„</label>
            <input type="text" id="path" placeholder="/ç›®å½•åç§°/" readonly>
            <select id="parentDir" style="display: none;">
              <option value="/">/</option>
            </select>
            <input type="text" id="itemName" placeholder="åç§°" style="display: none;">
          </div>

          <div class="form-group" id="codeGroup" style="display: none;">
            <label for="code">ä»£ç å†…å®¹</label>
            <textarea id="code" rows="6" placeholder="è¾“å…¥ä»£ç å†…å®¹"></textarea>
          </div>

          <div class="form-group" id="languageGroup" style="display: none;">
            <label for="language">è¯­è¨€</label>
            <select id="language">
              <option value="javascript">JavaScript</option>
              <option value="typescript">TypeScript</option>
              <option value="html">HTML</option>
              <option value="css">CSS</option>
              <option value="python">Python</option>
              <option value="java">Java</option>
              <option value="csharp">C#</option>
              <option value="cpp">C++</option>
              <option value="go">Go</option>
              <option value="rust">Rust</option>
              <option value="php">PHP</option>
              <option value="ruby">Ruby</option>
            </select>
          </div>

          <div class="form-group">
            <button id="executeBtn" class="primary">æ‰§è¡Œæ“ä½œ</button>
          </div>
        </div>
      </div>

      <div class="history-panel">
        <div class="panel-header">
          <h2>å†å²è®°å½•</h2>
          <button id="copyHistoryBtn" title="å¤åˆ¶åŸå§‹å†å²è®°å½•å†…å®¹">å¤åˆ¶åŸå§‹å†…å®¹</button>
        </div>
        <div id="historyRecords" class="history-records">
          <div class="history-header">
            <span class="op-type">æ“ä½œ</span>
            <span class="path">è·¯å¾„</span>
            <span class="hash">å“ˆå¸Œå€¼</span>
            <span class="timestamp">æ—¶é—´æˆ³</span>
            <span class="device">è®¾å¤‡</span>
          </div>
          <div id="historyContent" class="history-content"></div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // å…¨å±€çŠ¶æ€
    const state = {
      directories: ['/'], // ç›®å½•åˆ—è¡¨ï¼Œä»¥ / å¼€å¤´å’Œç»“å°¾
      snippets: [], // ä»£ç ç‰‡æ®µåˆ—è¡¨ï¼ŒåŒ…å«è·¯å¾„å’Œå†…å®¹
      history: [], // å†å²è®°å½•
      selectedPath: '/' // å½“å‰é€‰ä¸­çš„è·¯å¾„
    }

    // é¡µé¢å…ƒç´ 
    const elements = {
      directoryTree: document.getElementById('directoryTree'),
      actionType: document.getElementById('actionType'),
      parentDir: document.getElementById('parentDir'),
      itemName: document.getElementById('itemName'),
      path: document.getElementById('path'),
      code: document.getElementById('code'),
      language: document.getElementById('language'),
      codeGroup: document.getElementById('codeGroup'),
      languageGroup: document.getElementById('languageGroup'),
      pathGroup: document.getElementById('pathGroup'),
      historyContent: document.getElementById('historyContent'),
      executeBtn: document.getElementById('executeBtn'),
      resetBtn: document.getElementById('resetBtn'),
      exportBtn: document.getElementById('exportBtn'),
      importBtn: document.getElementById('importBtn'),
      importFile: document.getElementById('importFile'),
      deviceSelector: document.getElementById('deviceSelector'),
      addDirBtn: document.getElementById('addDirBtn')
    }

    // å·¥å…·å‡½æ•° - è®¡ç®—SHA256å“ˆå¸Œ
    async function calculateSHA256(str) {
      const encoder = new TextEncoder()
      const data = encoder.encode(str)
      const hashBuffer = await crypto.subtle.digest('SHA-256', data)
      const hashArray = Array.from(new Uint8Array(hashBuffer))
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('')
      return hashHex
    }

    // å·¥å…·å‡½æ•° - ç”ŸæˆISOæ ¼å¼çš„æ—¶é—´æˆ³
    function generateTimestamp() {
      return new Date().toISOString()
    }

    // å·¥å…·å‡½æ•° - è·å–å½“å‰è®¾å¤‡æ ‡è¯†
    function getCurrentDevice() {
      return elements.deviceSelector.value
    }

    // æ ¹æ®æ›´æ–°çš„å†å²è®°å½•è§„åˆ™ä¿®æ”¹å·¥å…·å‡½æ•° - æ·»åŠ å†å²è®°å½•
    async function addHistoryRecord(opType, path, content = null) {
      const timestamp = generateTimestamp()
      const device = getCurrentDevice()
      
      let hash = '#' // é»˜è®¤ä¸ºå ä½ç¬¦
      
      // å¯¹äºæ–°å¢å’Œä¿®æ”¹æ–‡ä»¶ï¼Œè®¡ç®—å“ˆå¸Œå€¼
      if ((opType === '+' || opType === '~') && content !== null) {
        hash = await calculateSHA256(content)
      } else if (opType === '-' && !path.endsWith('/') && content !== null) {
        // å¯¹äºæ–‡ä»¶åˆ é™¤æ“ä½œï¼Œå¦‚æœæä¾›äº†å†…å®¹ï¼Œä¹Ÿè®¡ç®—å“ˆå¸Œå€¼
        hash = await calculateSHA256(content)
      }
      
      // å¯¹äºå¼ºåˆ¶æ¸…ç©ºæ“ä½œ(!), ä½¿ç”¨å ä½ç¬¦
      if (opType === '!') {
        hash = '#'
      }
      
      // åˆ›å»ºå†å²è®°å½•æ¡ç›®
      const historyEntry = {
        opType,
        path,
        hash,
        timestamp,
        device
      }
      
      // æ·»åŠ åˆ°å†å²è®°å½•æ•°ç»„
      state.history.push(historyEntry)
      
      // æ›´æ–°UI
      renderHistoryRecords()
      
      // è¿”å›åˆ›å»ºçš„è®°å½•
      return historyEntry
    }

    // æ›´æ–°ç›®å½•ä¸‹æ‹‰é€‰æ‹©æ¡†
    function updateDirectorySelect() {
      // æ¸…ç©ºç°æœ‰é€‰é¡¹
      elements.parentDir.innerHTML = ''

      // æ·»åŠ æ‰€æœ‰ç›®å½•ä½œä¸ºé€‰é¡¹
      state.directories.forEach(dir => {
        const option = document.createElement('option')
        option.value = dir
        option.textContent = dir
        elements.parentDir.appendChild(option)
      })
    }

    // æ¸²æŸ“ç›®å½•æ ‘
    function renderDirectoryTree() {
      // æ¸…ç©ºç›®å½•æ ‘å†…å®¹
      elements.directoryTree.innerHTML = `
        <div class="root-node">
          <div class="tree-node-header ${state.selectedPath === '/' ? 'selected' : ''}" data-path="/">
            <span class="tree-node-icon">ğŸ“</span>
            <span class="tree-node-content">æ ¹ç›®å½•</span>
          </div>
          <div class="tree-node-children" id="root-children"></div>
        </div>
      `

      const rootChildren = document.getElementById('root-children')

      // æ„å»ºç›®å½•æ ‘ç»“æ„
      const directoryStructure = {}

      // æ·»åŠ æ‰€æœ‰ç›®å½•åˆ°ç»“æ„ä¸­
      state.directories.forEach(dir => {
        if (dir === '/') return // è·³è¿‡æ ¹ç›®å½•

        const parts = dir.split('/').filter(Boolean)
        let current = directoryStructure

        parts.forEach(part => {
          current[part] = current[part] || { __type: 'directory', __children: {} }
          current = current[part].__children
        })
      })

      // æ·»åŠ æ‰€æœ‰ä»£ç ç‰‡æ®µåˆ°ç»“æ„ä¸­
      state.snippets.forEach(snippet => {
        const pathParts = snippet.path.split('/').filter(Boolean)
        const fileName = pathParts.pop() // è·å–æ–‡ä»¶å

        let current = directoryStructure

        pathParts.forEach(part => {
          if (!current[part]) {
            current[part] = { __type: 'directory', __children: {} }
          }
          current = current[part].__children
        })

        current[fileName] = { __type: 'snippet', __data: snippet }
      })

      // é€’å½’æ„å»ºç›®å½•æ ‘DOM
      function buildTreeNode(structure, parentElement, parentPath = '/') {
        Object.keys(structure).forEach(key => {
          const item = structure[key]

          if (key === '__type' || key === '__children' || key === '__data') return

          const isDirectory = item.__type === 'directory'
          const currentPath = isDirectory
            ? `${parentPath}${key}/`
            : `${parentPath}${key}`

          // åˆ›å»ºèŠ‚ç‚¹å®¹å™¨
          const nodeElement = document.createElement('div')
          nodeElement.className = `tree-node ${isDirectory ? 'directory' : 'file'}`
          
          // åˆ›å»ºèŠ‚ç‚¹æ ‡é¢˜è¡Œ
          const headerElement = document.createElement('div')
          headerElement.className = `tree-node-header ${state.selectedPath === currentPath ? 'selected' : ''}`
          headerElement.setAttribute('data-path', currentPath)
          
          // åˆ›å»ºå›¾æ ‡
          const iconElement = document.createElement('span')
          iconElement.className = 'tree-node-icon'
          iconElement.textContent = isDirectory ? 'ğŸ“' : 'ğŸ“„'
          
          // åˆ›å»ºå†…å®¹åŒºåŸŸ
          const contentElement = document.createElement('span')
          contentElement.className = 'tree-node-content'
          contentElement.textContent = key
          
          // åˆ›å»ºæ“ä½œåŒºåŸŸ
          const actionsElement = document.createElement('div')
          actionsElement.className = 'tree-node-actions'
          
          // æ·»åŠ åˆ é™¤æŒ‰é’®
          const deleteButton = document.createElement('button')
          deleteButton.className = 'action-delete'
          deleteButton.textContent = 'Ã—'
          deleteButton.title = 'åˆ é™¤'
          deleteButton.addEventListener('click', async (e) => {
            e.stopPropagation()
            
            if (isDirectory) {
              if (confirm(`ç¡®å®šè¦åˆ é™¤ç›®å½• "${key}" åŠå…¶æ‰€æœ‰å†…å®¹å—ï¼Ÿ`)) {
                await deleteDirectory(currentPath)
                renderDirectoryTree()
              }
            } else {
              if (confirm(`ç¡®å®šè¦åˆ é™¤ä»£ç ç‰‡æ®µ "${key}" å—ï¼Ÿ`)) {
                await deleteSnippet(currentPath)
                renderDirectoryTree()
              }
            }
          })
          
          // ç»„è£…æ ‡é¢˜è¡Œ
          headerElement.appendChild(iconElement)
          headerElement.appendChild(contentElement)
          actionsElement.appendChild(deleteButton)
          headerElement.appendChild(actionsElement)
          
          // æ·»åŠ æ ‡é¢˜è¡Œåˆ°èŠ‚ç‚¹
          nodeElement.appendChild(headerElement)
          
          // ç‚¹å‡»é€‰æ‹©
          headerElement.addEventListener('click', (e) => {
            e.stopPropagation()
            selectPath(currentPath)
          })

          // å¦‚æœæ˜¯ç›®å½•ï¼Œæ·»åŠ å­é¡¹å®¹å™¨
          if (isDirectory) {
            const childrenContainer = document.createElement('div')
            childrenContainer.className = 'tree-node-children'
            nodeElement.appendChild(childrenContainer)
            
            // é€’å½’æ„å»ºå­èŠ‚ç‚¹
            buildTreeNode(item.__children, childrenContainer, currentPath)
          }
          
          // æ·»åŠ å®Œæ•´èŠ‚ç‚¹åˆ°çˆ¶å…ƒç´ 
          parentElement.appendChild(nodeElement)
        })
      }

      // æ„å»ºæ•´ä¸ªæ ‘
      buildTreeNode(directoryStructure, rootChildren)

      // æ›´æ–°ç›®å½•é€‰æ‹©æ¡†
      updateDirectorySelect()
    }

    // æ¸²æŸ“å†å²è®°å½•
    function renderHistoryRecords() {
      elements.historyContent.innerHTML = ''

      state.history.forEach(record => {
        const recordElement = document.createElement('div')
        recordElement.className = 'history-item'

        // æ“ä½œç±»å‹
        const opTypeClass = record.opType === '+' ? 'add' :
          record.opType === '~' ? 'modify' :
            record.opType === '-' ? 'delete' : 'reset'

        recordElement.innerHTML = `
            <span class="op-type ${opTypeClass}">${record.opType}</span>
            <span class="path">${record.path}</span>
            <span class="hash">${record.hash}</span>
            <span class="timestamp">${record.timestamp}</span>
            <span class="device">${record.device}</span>
        `

        elements.historyContent.appendChild(recordElement)
      })

      // æ»šåŠ¨åˆ°åº•éƒ¨
      elements.historyContent.scrollTop = elements.historyContent.scrollHeight
    }

    // é€‰æ‹©è·¯å¾„
    function selectPath(path) {
      state.selectedPath = path

      // æ›´æ–°UIä»¥åæ˜ é€‰æ‹©
      document.querySelectorAll('.tree-node-header').forEach(el => {
        el.classList.toggle('selected', el.getAttribute('data-path') === path)
      })

      // æ›´æ–°è·¯å¾„è¾“å…¥æ¡†
      elements.path.value = path

      // å¦‚æœé€‰æ‹©äº†ç›®å½•ï¼Œåˆ™æ›´æ–°parentDiré€‰æ‹©æ¡†
      if (path.endsWith('/')) {
        elements.parentDir.value = path
      }

      // å¦‚æœé€‰æ‹©äº†ä»£ç ç‰‡æ®µï¼Œåˆ™æ›´æ–°ä»£ç æ¡†
      updateFormForSelectedPath()
    }

    // æ ¹æ®é€‰æ‹©çš„è·¯å¾„æ›´æ–°è¡¨å•
    function updateFormForSelectedPath() {
      const path = state.selectedPath

      // å¦‚æœé€‰æ‹©äº†ä»£ç ç‰‡æ®µ
      if (!path.endsWith('/')) {
        // æŸ¥æ‰¾è¯¥ä»£ç ç‰‡æ®µ
        const snippet = state.snippets.find(s => {
          const fullPath = s.path
          return fullPath === path
        })

        if (snippet) {
          // è®¾ç½®ä»£ç å†…å®¹å’Œè¯­è¨€
          elements.code.value = snippet.code
          elements.language.value = snippet.language

          // å°†æ“ä½œç±»å‹è®¾ç½®ä¸ºä¿®æ”¹ä»£ç ç‰‡æ®µ
          elements.actionType.value = 'modifySnippet'

          // æ›´æ–°è¡¨å•æ˜¾ç¤º
          updateFormDisplay()
        }
      } else {
        // å¦‚æœé€‰æ‹©äº†ç›®å½•ï¼Œé»˜è®¤ä¸ºæ–°å¢ä»£ç ç‰‡æ®µ
        elements.actionType.value = 'addSnippet'
        elements.code.value = ''

        // æ›´æ–°è¡¨å•æ˜¾ç¤º
        updateFormDisplay()
      }
    }

    // æ›´æ–°è¡¨å•æ˜¾ç¤º
    function updateFormDisplay() {
      const actionType = elements.actionType.value

      // æ˜¾ç¤º/éšè—ä»£ç è¾“å…¥åŒºåŸŸ
      elements.codeGroup.style.display =
        (actionType === 'addSnippet' || actionType === 'modifySnippet')
          ? 'flex'
          : 'none'

      // æ˜¾ç¤º/éšè—è¯­è¨€é€‰æ‹©
      elements.languageGroup.style.display =
        (actionType === 'addSnippet' || actionType === 'modifySnippet')
          ? 'flex'
          : 'none'

      // æ›´æ–°è·¯å¾„è¾“å…¥åŒºåŸŸ
      if (actionType === 'forceReset') {
        // å¼ºåˆ¶é‡ç½®ä¸éœ€è¦è·¯å¾„
        elements.pathGroup.style.display = 'none'
      } else if (actionType === 'addDir') {
        // æ–°å¢ç›®å½•éœ€è¦é€‰æ‹©çˆ¶ç›®å½•å’Œè¾“å…¥ç›®å½•å
        elements.pathGroup.style.display = 'flex'
        elements.parentDir.style.display = 'block'
        elements.itemName.style.display = 'block'
        elements.path.style.display = 'none'

        elements.itemName.placeholder = "ç›®å½•åç§°"
      } else if (actionType === 'deleteItem') {
        // åˆ é™¤æ“ä½œä½¿ç”¨å½“å‰è·¯å¾„
        elements.pathGroup.style.display = 'flex'
        elements.parentDir.style.display = 'none'
        elements.itemName.style.display = 'none'
        elements.path.style.display = 'block'
      } else {
        // å…¶ä»–æ“ä½œ
        elements.pathGroup.style.display = 'flex'

        if (actionType === 'addSnippet') {
          // æ–°å¢ä»£ç ç‰‡æ®µéœ€è¦é€‰æ‹©çˆ¶ç›®å½•å’Œè¾“å…¥æ–‡ä»¶å
          elements.parentDir.style.display = 'block'
          elements.itemName.style.display = 'block'
          elements.path.style.display = 'none'

          elements.itemName.placeholder = "æ–‡ä»¶å"
        } else {
          // ä¿®æ”¹ä»£ç ç‰‡æ®µä½¿ç”¨å½“å‰è·¯å¾„
          elements.parentDir.style.display = 'none'
          elements.itemName.style.display = 'none'
          elements.path.style.display = 'block'
        }
      }
    }

    // ä¿®æ”¹åˆ é™¤å‡½æ•°ï¼Œç§»é™¤showNotificationè°ƒç”¨
    async function deleteItem() {
      const path = elements.path.value
      
      if (!path || path === '/') {
        throw new Error('æ— æ³•åˆ é™¤æ ¹ç›®å½•')
      }
      
      // ç¡®è®¤åˆ é™¤
      if (!confirm(`ç¡®å®šè¦åˆ é™¤ "${path}" å—ï¼Ÿ${path.endsWith('/') ? 'è¿™å°†åŒæ—¶åˆ é™¤è¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰å†…å®¹ã€‚' : ''}`)) {
        return
      }
      
      if (path.endsWith('/')) {
        // åˆ é™¤ç›®å½•
        await deleteDirectory(path)
      } else {
        // åˆ é™¤ä»£ç ç‰‡æ®µ
        await deleteSnippet(path)
      }
    }
    
    // åˆ é™¤ä»£ç ç‰‡æ®µ
    async function deleteSnippet(path) {
      // æŸ¥æ‰¾ä»£ç ç‰‡æ®µ
      const snippetIndex = state.snippets.findIndex(s => s.path === path)
      
      if (snippetIndex === -1) {
        throw new Error('ä»£ç ç‰‡æ®µä¸å­˜åœ¨')
      }
      
      // è·å–ä»£ç ç‰‡æ®µå†…å®¹ï¼Œç”¨äºè®¡ç®—å“ˆå¸Œ
      const snippet = state.snippets[snippetIndex]
      const snippetContent = snippet.code
      
      // ä»åˆ—è¡¨ä¸­ç§»é™¤
      state.snippets.splice(snippetIndex, 1)
      
      // æ·»åŠ åˆ é™¤è®°å½•ï¼Œä¼ é€’å†…å®¹ä»¥ä¾¿è®¡ç®—å“ˆå¸Œ
      await addHistoryRecord('-', path, snippetContent)
      
      // é€‰æ‹©çˆ¶ç›®å½•
      const parentPath = path.substring(0, path.lastIndexOf('/') + 1)
      selectPath(parentPath)
      
      // æ˜¾ç¤ºé€šçŸ¥
      showNotification(`ä»£ç ç‰‡æ®µ ${path} å·²åˆ é™¤`, 'success')
    }
    
    // åˆ é™¤ç›®å½•åŠå…¶å†…å®¹
    async function deleteDirectory(dirPath) {
      // 1. å…ˆæ”¶é›†è¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰é¡¹ç›®ï¼ˆåŒ…æ‹¬å­ç›®å½•å’Œä»£ç ç‰‡æ®µï¼‰
      const itemsToDelete = []
      
      // æ”¶é›†ä»£ç ç‰‡æ®µ
      const snippetsToDelete = state.snippets.filter(s => s.path.startsWith(dirPath))
      snippetsToDelete.forEach(snippet => {
        itemsToDelete.push({
          type: 'snippet',
          path: snippet.path
        })
      })
      
      // æ”¶é›†å­ç›®å½•ï¼ˆæŒ‰è·¯å¾„é•¿åº¦é™åºæ’åˆ—ï¼Œç¡®ä¿å…ˆåˆ é™¤æ·±å±‚ç›®å½•ï¼‰
      const subDirs = state.directories
        .filter(d => d.startsWith(dirPath) && d !== dirPath)
        .sort((a, b) => b.length - a.length)
      
      subDirs.forEach(dir => {
        itemsToDelete.push({
          type: 'directory',
          path: dir
        })
      })
      
      // æœ€åæ·»åŠ è¦åˆ é™¤çš„ç›®å½•æœ¬èº«
      itemsToDelete.push({
        type: 'directory',
        path: dirPath
      })
      
      // 2. æŒ‰ç…§æ­£ç¡®é¡ºåºåˆ é™¤é¡¹ç›®å¹¶è®°å½•å†å²
      for (const item of itemsToDelete) {
        if (item.type === 'snippet') {
          // åˆ é™¤ä»£ç ç‰‡æ®µ
          const snippetIndex = state.snippets.findIndex(s => s.path === item.path)
          if (snippetIndex !== -1) {
            state.snippets.splice(snippetIndex, 1)
            await addHistoryRecord('-', item.path)
          }
        } else {
          // åˆ é™¤ç›®å½•
          const dirIndex = state.directories.indexOf(item.path)
          if (dirIndex !== -1) {
            state.directories.splice(dirIndex, 1)
            await addHistoryRecord('-', item.path)
          }
        }
      }
      
      // 3. é€‰æ‹©çˆ¶ç›®å½•
      const parentPath = dirPath.substring(0, dirPath.split('/').slice(0, -2).join('/').length + 1)
      selectPath(parentPath || '/')
      
      // æ˜¾ç¤ºé€šçŸ¥
      showNotification(`ç›®å½• ${dirPath} åŠå…¶å†…å®¹å·²åˆ é™¤`, 'success')
    }

    // æ‰§è¡Œæ“ä½œ
    async function executeOperation() {
      const actionType = elements.actionType.value
      
      try {
        switch (actionType) {
          case 'addDir':
            await addDirectory()
            break
          case 'addSnippet':
            await addSnippet()
            break
          case 'modifySnippet':
            await modifySnippet()
            break
          case 'deleteItem':
            await deleteItem()
            break
          case 'forceReset':
            await forceReset()
            break
        }
        
        // æ¸…ç©ºè¡¨å•
        elements.itemName.value = ''
        elements.code.value = ''
        
        // æ›´æ–°UI
        renderDirectoryTree()
      } catch (error) {
        showNotification(error.message, 'error')
        console.error(error)
      }
    }

    // æ·»åŠ ç›®å½•
    async function addDirectory() {
      const parentDir = elements.parentDir.value
      const dirName = elements.itemName.value.trim()

      if (!dirName) {
        throw new Error('ç›®å½•åä¸èƒ½ä¸ºç©º')
      }

      if (dirName.includes('/')) {
        throw new Error('ç›®å½•åä¸èƒ½åŒ…å«æ–œæ ')
      }

      const newDirPath = `${parentDir}${dirName}/`

      // æ£€æŸ¥ç›®å½•æ˜¯å¦å·²å­˜åœ¨
      if (state.directories.includes(newDirPath)) {
        throw new Error('ç›®å½•å·²å­˜åœ¨')
      }

      // æ·»åŠ åˆ°ç›®å½•åˆ—è¡¨
      state.directories.push(newDirPath)

      // æ·»åŠ å†å²è®°å½•
      await addHistoryRecord('+', newDirPath)

      // é€‰æ‹©æ–°åˆ›å»ºçš„ç›®å½•
      selectPath(newDirPath)
    }

    // æ·»åŠ ä»£ç ç‰‡æ®µ
    async function addSnippet() {
      const parentDir = elements.parentDir.value
      const fileName = elements.itemName.value.trim()
      const code = elements.code.value
      const language = elements.language.value

      if (!fileName) {
        throw new Error('æ–‡ä»¶åä¸èƒ½ä¸ºç©º')
      }

      if (fileName.includes('/')) {
        throw new Error('æ–‡ä»¶åä¸èƒ½åŒ…å«æ–œæ ')
      }

      const snippetPath = `${parentDir}${fileName}`

      // æ£€æŸ¥ä»£ç ç‰‡æ®µæ˜¯å¦å·²å­˜åœ¨
      if (state.snippets.some(s => s.path === snippetPath)) {
        throw new Error('ä»£ç ç‰‡æ®µå·²å­˜åœ¨')
      }

      // åˆ›å»ºæ–°çš„ä»£ç ç‰‡æ®µ
      const newSnippet = {
        path: snippetPath,
        code,
        language,
        createdAt: new Date().toISOString()
      }

      // æ·»åŠ åˆ°ä»£ç ç‰‡æ®µåˆ—è¡¨
      state.snippets.push(newSnippet)

      // æ·»åŠ å†å²è®°å½•
      await addHistoryRecord('+', snippetPath, code)

      // é€‰æ‹©æ–°åˆ›å»ºçš„ä»£ç ç‰‡æ®µ
      selectPath(snippetPath)
    }

    // ä¿®æ”¹ä»£ç ç‰‡æ®µ
    async function modifySnippet() {
      const path = elements.path.value
      const code = elements.code.value
      const language = elements.language.value

      // æŸ¥æ‰¾ä»£ç ç‰‡æ®µ
      const snippetIndex = state.snippets.findIndex(s => s.path === path)

      if (snippetIndex === -1) {
        throw new Error('ä»£ç ç‰‡æ®µä¸å­˜åœ¨')
      }

      // æ›´æ–°ä»£ç ç‰‡æ®µ
      state.snippets[snippetIndex].code = code
      state.snippets[snippetIndex].language = language
      state.snippets[snippetIndex].updatedAt = new Date().toISOString()

      // æ·»åŠ å†å²è®°å½•
      await addHistoryRecord('~', path, code)
    }

    // å¼ºåˆ¶é‡ç½®
    async function forceReset() {
      if (!confirm('ç¡®å®šè¦å¼ºåˆ¶é‡ç½®å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰æ•°æ®å¹¶åˆ›å»ºä¸€ä¸ªç³»ç»Ÿé‡ç½®è®°å½•ã€‚')) {
        return
      }

      // æ¸…é™¤æ‰€æœ‰æ•°æ®
      state.directories = ['/']
      state.snippets = []
      state.history = []

      // æ·»åŠ å¼ºåˆ¶é‡ç½®å†å²è®°å½•
      await addHistoryRecord('!', 'SYSTEM_RESET')

      // é€‰æ‹©æ ¹ç›®å½•
      selectPath('/')
    }

    // æ¸…é™¤æ‰€æœ‰æ•°æ®
    function resetAll() {
      if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ç›®å½•ã€ä»£ç ç‰‡æ®µå’Œå†å²è®°å½•ã€‚')) {
        return
      }

      // é‡ç½®çŠ¶æ€
      state.directories = ['/']
      state.snippets = []
      state.history = []
      state.selectedPath = '/'

      // æ›´æ–°UI
      renderDirectoryTree()
      renderHistoryRecords()
      elements.path.value = '/'
      elements.code.value = ''
      elements.itemName.value = ''
      
      showNotification('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤', 'warning')
    }

    // å¯¼å‡ºå†å²è®°å½•
    function exportHistory() {
      const historyText = state.history.map(record =>
        `${record.opType}|${record.path}|${record.hash}|${record.timestamp}|${record.device}`
      ).join('\n')

      const blob = new Blob([historyText], { type: 'text/plain' })
      const url = URL.createObjectURL(blob)

      const a = document.createElement('a')
      a.href = url
      a.download = 'history.txt'
      a.click()

      URL.revokeObjectURL(url)
    }

    // å¯¼å…¥å†å²è®°å½•
    function importHistory() {
      elements.importFile.click()
    }

    // å¤„ç†å¯¼å…¥æ–‡ä»¶
    function handleImportFile(event) {
      const file = event.target.files[0]
      if (!file) return

      const reader = new FileReader()

      reader.onload = function (e) {
        const content = e.target.result
        parseImportedHistory(content)
      }

      reader.readAsText(file)
    }

    // è§£æå¯¼å…¥çš„å†å²è®°å½•
    function parseImportedHistory(content) {
      try {
        const lines = content.split('\n').filter(line => line.trim())
        
        // æ¸…é™¤ç°æœ‰æ•°æ®
        resetAll()
        
        // éªŒè¯ç¬¬ä¸€æ¡è®°å½•æ˜¯å¦ç¬¦åˆè§„åˆ™
        if (lines.length > 0) {
          const firstRecord = lines[0].split('|')
          const firstOpType = firstRecord[0]
          
          if (firstOpType !== '+' && firstOpType !== '!') {
            throw new Error('å†å²è®°å½•çš„ç¬¬ä¸€æ¡å¿…é¡»æ˜¯å¼ºåˆ¶é‡ç½®(!)æˆ–æ–°å¢(+)æ“ä½œ')
          }
        }
        
        // éªŒè¯æ—¶é—´æˆ³æ˜¯å¦é€’å¢
        let lastTimestamp = null
        for (const line of lines) {
          const parts = line.split('|')
          const timestamp = parts[3]
          
          if (lastTimestamp !== null && new Date(timestamp) <= new Date(lastTimestamp)) {
            throw new Error('å†å²è®°å½•å¿…é¡»æŒ‰æ—¶é—´æˆ³ä¸¥æ ¼é€’å¢')
          }
          
          lastTimestamp = timestamp
        }
        
        // è§£ææ¯è¡Œå¹¶é‡å»ºçŠ¶æ€
        for (const line of lines) {
          const [opType, path, hash, timestamp, device] = line.split('|')
          
          // æ·»åŠ åˆ°å†å²è®°å½•
          state.history.push({
            opType,
            path,
            hash,
            timestamp,
            device
          })
          
          // æ ¹æ®æ“ä½œç±»å‹æ›´æ–°çŠ¶æ€
          if (opType === '+') {
            if (path.endsWith('/')) {
              // æ·»åŠ ç›®å½•
              if (!state.directories.includes(path)) {
                state.directories.push(path)
              }
            } else {
              // æ·»åŠ ä»£ç ç‰‡æ®µ
              state.snippets.push({
                path,
                code: '// å¯¼å…¥çš„ä»£ç å†…å®¹',
                language: 'javascript',
                createdAt: timestamp
              })
            }
          } else if (opType === '-') {
            if (path.endsWith('/')) {
              // åˆ é™¤ç›®å½•
              const index = state.directories.indexOf(path)
              if (index !== -1) {
                state.directories.splice(index, 1)
              }
            } else {
              // åˆ é™¤ä»£ç ç‰‡æ®µ
              const index = state.snippets.findIndex(s => s.path === path)
              if (index !== -1) {
                state.snippets.splice(index, 1)
              }
            }
          } else if (opType === '!') {
            // å¼ºåˆ¶é‡ç½®ï¼Œé‡ç½®æ‰€æœ‰çŠ¶æ€
            state.directories = ['/']
            state.snippets = []
            // å†å²è®°å½•ä¿ç•™ï¼Œå› ä¸ºæˆ‘ä»¬æ­£åœ¨å¯¼å…¥å®ƒ
          }
        }
        
        // æ›´æ–°UI
        renderDirectoryTree()
        renderHistoryRecords()
        
        showNotification('å†å²è®°å½•å¯¼å…¥æˆåŠŸ', 'success')
      } catch (error) {
        showNotification(`å¯¼å…¥å¤±è´¥: ${error.message}`, 'error')
        console.error(error)
      }
      
      // æ¸…é™¤æ–‡ä»¶è¾“å…¥
      elements.importFile.value = ''
    }

    // å¤åˆ¶å†å²è®°å½•çš„åŸå§‹å†…å®¹
    function copyHistoryRaw() {
      const historyText = state.history.map(record =>
        `${record.opType}|${record.path}|${record.hash}|${record.timestamp}|${record.device}`
      ).join('\n')
      
      // å¤åˆ¶åˆ°å‰ªè´´æ¿
      navigator.clipboard.writeText(historyText)
        .then(() => {
          showNotification('å†å²è®°å½•å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success')
        })
        .catch(err => {
          console.error('å¤åˆ¶å¤±è´¥:', err)
          
          // å¦‚æœå¤åˆ¶å¤±è´¥ï¼Œæä¾›å¤‡ç”¨æ–¹æ³•
          const textarea = document.createElement('textarea')
          textarea.value = historyText
          document.body.appendChild(textarea)
          textarea.select()
          document.execCommand('copy')
          document.body.removeChild(textarea)
          showNotification('å†å²è®°å½•å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success')
        })
    }

    // éšæœºç”Ÿæˆå†å²è®°å½•
    async function generateRandomHistory() {
      if (state.history.length > 0 || state.directories.length > 1 || state.snippets.length > 0) {
        if (!confirm('ç”Ÿæˆéšæœºå†å²è®°å½•å°†æ¸…é™¤ç°æœ‰çš„æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
          return
        }
        resetAll()
      }
      
      // è¯­è¨€é€‰é¡¹
      const languages = ['javascript', 'typescript', 'html', 'css', 'python', 'java', 'csharp', 'cpp', 'go', 'rust', 'php', 'ruby']
      
      // éšæœºè®¾å¤‡
      const devices = ['device1', 'device2', 'device3']
      
      // ç›®å½•å’Œæ–‡ä»¶åç”Ÿæˆ
      const dirPrefixes = ['api', 'components', 'utils', 'models', 'views', 'services', 'helpers', 'config', 'lib', 'hooks']
      const filePrefixes = ['user', 'auth', 'data', 'main', 'helper', 'util', 'config', 'base', 'app', 'index', 'service']
      const fileSuffixes = ['', 'Controller', 'Service', 'Model', 'View', 'Component', 'Hook', 'Utils', 'Helper', 'Manager']
      
      // éšæœºä»£ç ç‰‡æ®µæ¨¡æ¿
      const codeTemplates = [
        "function ${name}() {\n  console.log('Hello, world!');\n  return true;\n}",
        "class ${name} {\n  constructor() {\n    this.value = 0;\n  }\n  \n  getValue() {\n    return this.value;\n  }\n}",
        "const ${name} = () => {\n  const data = [];\n  return {\n    add: (item) => data.push(item),\n    getAll: () => data\n  };\n};",
        "import { useState } from 'react';\n\nfunction ${name}() {\n  const [count, setCount] = useState(0);\n  return (\n    <div>\n      <p>Count: {count}</p>\n      <button onClick={() => setCount(count + 1)}>Increment</button>\n    </div>\n  );\n}",
        "def ${name}(value):\n    \"\"\"A simple function example\"\"\"\n    return value * 2"
      ]
      
      // éšæœºè·å–æ•°ç»„ä¸­çš„å…ƒç´ 
      const getRandomItem = (array) => array[Math.floor(Math.random() * array.length)]
      
      // ç”Ÿæˆéšæœºçš„åç§°
      const generateRandomName = (isDir = false) => {
        if (isDir) {
          return getRandomItem(dirPrefixes)
        } else {
          return getRandomItem(filePrefixes) + getRandomItem(fileSuffixes)
        }
      }
      
      // ç”Ÿæˆéšæœºä»£ç 
      const generateRandomCode = (name) => {
        const template = getRandomItem(codeTemplates)
        return template.replace('${name}', name)
      }
      
      // ç”Ÿæˆéšæœºæ—¶é—´æˆ³ï¼ˆç¡®ä¿æ—¶é—´æˆ³æ˜¯é€’å¢çš„ï¼‰
      let lastTimestamp = new Date().getTime() - 1000 * 60 * 60 * 24 * 30 // ä»30å¤©å‰å¼€å§‹
      const generateTimestamp = () => {
        lastTimestamp += Math.floor(Math.random() * 1000 * 60 * 60) + 1000 // å¢åŠ 1ç§’åˆ°1å°æ—¶çš„éšæœºæ—¶é—´
        return new Date(lastTimestamp).toISOString()
      }
      
      // å†³å®šæ˜¯å¦æ‰§è¡Œå¼ºåˆ¶é‡ç½®
      const shouldReset = Math.random() < 0.3 // 30%çš„æ¦‚ç‡æ‰§è¡Œå¼ºåˆ¶é‡ç½®
      
      if (shouldReset) {
        // æ‰§è¡Œå¼ºåˆ¶é‡ç½®
        const timestamp = generateTimestamp()
        const device = getRandomItem(devices)
        
        // æ·»åŠ å¼ºåˆ¶é‡ç½®è®°å½•
        state.history.push({
          opType: '!',
          path: 'SYSTEM_RESET',
          hash: '#',
          timestamp,
          device
        })
      }
      
      // åˆ›å»ºéšæœºç›®å½•ç»“æ„ï¼ˆ1-5ä¸ªé¡¶çº§ç›®å½•ï¼Œä¸å…è®¸åµŒå¥—ç›®å½•ï¼‰
      const dirCount = Math.floor(Math.random() * 5) + 1
      const directories = []
      
      for (let i = 0; i < dirCount; i++) {
        let dirName
        let attempts = 0
        
        // ç¡®ä¿ç›®å½•åä¸é‡å¤
        do {
          dirName = generateRandomName(true)
          attempts++
        } while (directories.includes(dirName) && attempts < 10)
        
        if (attempts < 10) {
          directories.push(dirName)
        }
      }
      
      // ä¸ºæ¯ä¸ªç›®å½•åˆ›å»ºå†å²è®°å½•å¹¶ç”Ÿæˆæ–‡ä»¶
      for (const dir of directories) {
        const dirPath = `/${dir}/`
        const timestamp = generateTimestamp()
        const device = getRandomItem(devices)
        
        // æ·»åŠ ç›®å½•
        state.directories.push(dirPath)
        state.history.push({
          opType: '+',
          path: dirPath,
          hash: '#',
          timestamp,
          device
        })
        
        // ä¸ºç›®å½•æ·»åŠ 1-5ä¸ªæ–‡ä»¶
        const fileCount = Math.floor(Math.random() * 5) + 1
        const filesInDir = []
        
        for (let j = 0; j < fileCount; j++) {
          let fileName
          let attempts = 0
          
          // ç¡®ä¿æ–‡ä»¶åä¸é‡å¤
          do {
            fileName = generateRandomName(false)
            attempts++
          } while (filesInDir.includes(fileName) && attempts < 10)
          
          if (attempts < 10) {
            filesInDir.push(fileName)
            
            const filePath = `${dirPath}${fileName}`
            const language = getRandomItem(languages)
            const code = generateRandomCode(fileName)
            const fileTimestamp = generateTimestamp()
            const fileDevice = getRandomItem(devices)
            
            // è®¡ç®—æ–‡ä»¶å†…å®¹çš„å“ˆå¸Œ
            const hash = await calculateSHA256(code)
            
            // æ·»åŠ æ–‡ä»¶
            state.snippets.push({
              path: filePath,
              code,
              language,
              createdAt: fileTimestamp
            })
            
            state.history.push({
              opType: '+',
              path: filePath,
              hash,
              timestamp: fileTimestamp,
              device: fileDevice
            })
            
            // å¯èƒ½çš„ä¿®æ”¹æ“ä½œï¼ˆ50%æ¦‚ç‡ï¼‰
            if (Math.random() < 0.5) {
              const modifiedCode = code + '\n// Modified at ' + new Date().toISOString()
              const modifyTimestamp = generateTimestamp()
              const modifyDevice = getRandomItem(devices)
              const modifyHash = await calculateSHA256(modifiedCode)
              
              // æ›´æ–°ä»£ç ç‰‡æ®µ
              const snippetIndex = state.snippets.findIndex(s => s.path === filePath)
              if (snippetIndex !== -1) {
                state.snippets[snippetIndex].code = modifiedCode
                state.snippets[snippetIndex].updatedAt = modifyTimestamp
              }
              
              // æ·»åŠ ä¿®æ”¹è®°å½•
              state.history.push({
                opType: '~',
                path: filePath,
                hash: modifyHash,
                timestamp: modifyTimestamp,
                device: modifyDevice
              })
            }
          }
        }
      }
      
      // éšæœºåˆ é™¤æ“ä½œï¼ˆ30%æ¦‚ç‡åˆ é™¤ä¸€ä¸ªç›®å½•æˆ–æ–‡ä»¶ï¼‰
      if (Math.random() < 0.3 && directories.length > 0) {
        // éšæœºé€‰æ‹©ä¸€ä¸ªç›®å½•åˆ é™¤
        const dirToDelete = getRandomItem(directories)
        const dirPath = `/${dirToDelete}/`
        
        // æŸ¥æ‰¾è¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
        const filesInDir = state.snippets.filter(s => s.path.startsWith(dirPath))
        
        // æŒ‰è§„åˆ™åˆ é™¤ï¼šå…ˆåˆ é™¤ç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œå†åˆ é™¤ç›®å½•æœ¬èº«
        for (const file of filesInDir) {
          const deleteTimestamp = generateTimestamp()
          const deleteDevice = getRandomItem(devices)
          
          // è·å–ä»£ç å†…å®¹ç”¨äºå“ˆå¸Œè®¡ç®—
          const fileContent = file.code
          
          // è®¡ç®—æ–‡ä»¶å†…å®¹çš„å“ˆå¸Œå€¼
          const deleteHash = await calculateSHA256(fileContent)
          
          // æ·»åŠ æ–‡ä»¶åˆ é™¤è®°å½•
          state.history.push({
            opType: '-',
            path: file.path,
            hash: deleteHash,
            timestamp: deleteTimestamp,
            device: deleteDevice
          })
          
          // ä»åˆ—è¡¨ä¸­ç§»é™¤æ–‡ä»¶
          const fileIndex = state.snippets.findIndex(s => s.path === file.path)
          if (fileIndex !== -1) {
            state.snippets.splice(fileIndex, 1)
          }
        }
        
        // åˆ é™¤ç›®å½•æœ¬èº«
        const dirDeleteTimestamp = generateTimestamp()
        const dirDeleteDevice = getRandomItem(devices)
        
        state.history.push({
          opType: '-',
          path: dirPath,
          hash: '#',
          timestamp: dirDeleteTimestamp,
          device: dirDeleteDevice
        })
        
        // ä»åˆ—è¡¨ä¸­ç§»é™¤ç›®å½•
        const dirIndex = state.directories.indexOf(dirPath)
        if (dirIndex !== -1) {
          state.directories.splice(dirIndex, 1)
        }
      }
      
      // æ›´æ–°UI
      renderDirectoryTree()
      renderHistoryRecords()
      
      showNotification(`å·²ç”Ÿæˆ ${state.history.length} æ¡éšæœºå†å²è®°å½•ï¼`, 'success')
    }

    // æ·»åŠ é€šçŸ¥åŠŸèƒ½
    function showNotification(message, type = 'info', duration = 3000) {
      // å…ˆç§»é™¤æ‰€æœ‰ç°æœ‰é€šçŸ¥
      const existingNotifications = document.querySelectorAll('.notification')
      existingNotifications.forEach(notif => {
        document.body.removeChild(notif)
      })
      
      // åˆ›å»ºæ–°é€šçŸ¥
      const notification = document.createElement('div')
      notification.className = `notification ${type}`
      notification.textContent = message
      
      // æ·»åŠ åˆ°é¡µé¢
      document.body.appendChild(notification)
      
      // æ˜¾ç¤ºé€šçŸ¥
      setTimeout(() => {
        notification.classList.add('show')
      }, 10)
      
      // å®šæ—¶ç§»é™¤
      setTimeout(() => {
        notification.classList.remove('show')
        setTimeout(() => {
          if (notification.parentNode) {
            document.body.removeChild(notification)
          }
        }, 300)
      }, duration)
    }
    
    // å¤åˆ¶æ ‘ç»“æ„
    function copyTreeStructure() {
      let treeText = 'æ ¹ç›®å½•/\n'
      
      // åˆ›å»ºæœ‰åºçš„ç›®å½•åˆ—è¡¨
      const sortedDirs = [...state.directories]
        .filter(dir => dir !== '/')
        .sort((a, b) => a.localeCompare(b))
      
      // åˆ›å»ºæœ‰åºçš„æ–‡ä»¶åˆ—è¡¨
      const sortedFiles = [...state.snippets]
        .sort((a, b) => a.path.localeCompare(b.path))
      
      // é€’å½’ç”Ÿæˆæ ‘
      function buildTreeText(path, indent) {
        // æ·»åŠ å½“å‰ç›®å½•ä¸‹çš„å­ç›®å½•
        const childDirs = sortedDirs.filter(dir => {
          // ä¸æ˜¯è‡ªå·±ï¼Œä½†æ˜¯ä»¥è‡ªå·±ä¸ºå‰ç¼€ï¼Œå¹¶ä¸”æ·±åº¦åªå·®ä¸€çº§
          const parts = dir.split('/').filter(Boolean)
          const parentParts = path.split('/').filter(Boolean)
          return dir !== path && 
                 dir.startsWith(path) && 
                 parts.length === parentParts.length + 1
        })
        
        childDirs.forEach(dir => {
          const dirName = dir.split('/').filter(Boolean).pop()
          treeText += `${indent}â”œâ”€â”€ ğŸ“ ${dirName}/\n`
          buildTreeText(dir, indent + 'â”‚   ')
        })
        
        // æ·»åŠ å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶
        const files = sortedFiles.filter(file => {
          const filePath = file.path
          const fileDir = filePath.substring(0, filePath.lastIndexOf('/') + 1)
          return fileDir === path
        })
        
        const lastIndex = files.length - 1
        files.forEach((file, index) => {
          const fileName = file.path.split('/').pop()
          const prefix = index === lastIndex && childDirs.length === 0 ? 'â””â”€â”€ ' : 'â”œâ”€â”€ '
          treeText += `${indent}${prefix}ğŸ“„ ${fileName}\n`
        })
      }
      
      buildTreeText('/', '');
      
      // å¤åˆ¶åˆ°å‰ªè´´æ¿
      navigator.clipboard.writeText(treeText)
        .then(() => {
          showNotification('æ ‘ç»“æ„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success')
        })
        .catch(err => {
          console.error('å¤åˆ¶å¤±è´¥:', err)
          
          // å¦‚æœå¤åˆ¶å¤±è´¥ï¼Œæä¾›å¤‡ç”¨æ–¹æ³•
          const textarea = document.createElement('textarea')
          textarea.value = treeText
          document.body.appendChild(textarea)
          textarea.select()
          document.execCommand('copy')
          document.body.removeChild(textarea)
          showNotification('æ ‘ç»“æ„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success')
        })
    }

    // åˆå§‹åŒ–åº”ç”¨
    function initApp() {
      // æ¸²æŸ“åˆå§‹ç›®å½•æ ‘
      renderDirectoryTree()

      // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
      elements.actionType.addEventListener('change', updateFormDisplay)
      elements.executeBtn.addEventListener('click', executeOperation)
      elements.resetBtn.addEventListener('click', resetAll)
      elements.exportBtn.addEventListener('click', exportHistory)
      elements.importBtn.addEventListener('click', importHistory)
      elements.importFile.addEventListener('change', handleImportFile)
      elements.addDirBtn.addEventListener('click', () => {
        elements.actionType.value = 'addDir'
        updateFormDisplay()
      })
      document.getElementById('copyTreeBtn').addEventListener('click', copyTreeStructure)
      document.getElementById('generateRandomBtn').addEventListener('click', generateRandomHistory)
      document.getElementById('copyHistoryBtn').addEventListener('click', copyHistoryRaw)

      // åˆå§‹æ›´æ–°è¡¨å•æ˜¾ç¤º
      updateFormDisplay()
    }

    // å¯åŠ¨åº”ç”¨
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>

</html>